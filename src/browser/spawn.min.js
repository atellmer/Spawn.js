var Spawn=function(){"use strict";function h(a,b){var e,c=a.split("."),d=n(b);for(e=0;e<c.length;e++){if(!d.hasOwnProperty(c[e]))return null;d=d[c[e]]}return d}function i(a,b){return JSON.stringify(h(a,b))}function j(a,b,c,d,e){var f;for(f in b)if(b.hasOwnProperty(f)){if(f===a){l(b[f]);continue}if(a.length<f.length&&new RegExp("^\\"+a+".","i").test(f)&&i(f,d)!==i(f,c)){l(b[f]);continue}if(a.length>f.length&&new RegExp("^\\"+f+".","i").test(a)){l(b[f]);continue}}e&&l(b["*"])}function k(a,b){var c;for(c in a)a.hasOwnProperty(c)&&("*"!==c&&b(c),l(a[c]))}function l(a){var b;for(b=0;b<a.length;b++)a[b]()}function m(a,b){var c;for(c=0;c<a.length;c++)if(a[c]===b)return!1;return!0}function n(a){return JSON.parse(JSON.stringify(a))}function o(a){return!(!p(a)||q(a))}function p(a){return"object"==typeof a}function q(a){var b=Object.prototype.toString.call(a);return"array"===b.slice(8,b.length-1).toLowerCase()}function r(a){return"function"==typeof a}function s(a){return"string"==typeof a}function t(a){throw new Error(a)}var a={},b={},c={},d={"*":[]},e="@@SPAWN/INIT",f=e,g=this;arguments[0]&&(o(arguments[0])||t("Spawn: the initial state must be plain object!"),a=arguments[0]),Spawn=function(){return g},g.getState=function(){return n(a)},g.select=function(b){if(s(b))switch(b){case"*":return n(a);case"->":return f;default:return h(b,a)}return r(b)?b(n(a)):void t("Spawn: the select method takes only a string or function as argument!")},g.detect=function(e,f){return s(e)||t("Spawn: the detect method takes only a string for first argument!"),r(f)||t("Spawn: the detect method takes only a function for second argument!"),d[e]||(d[e]=[]),"*"===e&&m(d[e],f)?(d[e].push(f),l(d[e]),g):m(d[e],f)?(d[e].push(f),h(e,a)&&(c=n(a),j(e,d,a,b,!1)),g):g},g.update=function(e,h){s(e)||t("Spawn: the update method takes only a string for first argument!");var u,m=e.split("."),p=n(a),q=p;if("*"===e){if(o(h))return a=n(h),b={},c={},f=e,k(d,function(a){f=a}),g;t("Spawn: the update method takes only a plain object for replace full state! Check your update('*') method.")}for(f=e,u=0;u<m.length;u++){if(p.hasOwnProperty(m[u])||(p[m[u]]={}),u===m.length-1){p[m[u]]=h;break}p=p[m[u]]}return c=n(q),i(e,a)!==i(e,c)?(a=n(c),j(e,d,a,b,!0),b=n(c)):l(d["*"]),g}};"undefined"!=typeof module&&module.exports&&(module.exports=Spawn);